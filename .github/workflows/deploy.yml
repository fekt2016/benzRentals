name: 🚀 Deploy to FTP
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  NODE_VERSION: '18'

jobs:
  build-and-deploy:
    name: "🔨 Build & 🚀 Deploy"
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout code
    - name: "📥 Checkout repository"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Step 2: Setup Node.js
    - name: "⚙️ Setup Node.js ${{ env.NODE_VERSION }}"
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    # Step 3: Install dependencies
    - name: "📦 Install dependencies"
      run: |
        npm ci
        npm list

    # Step 4: Build project
    - name: "🔨 Build project"
      run: |
        npm run build
        echo "Build completed successfully!"

    # Step 5: Verify build output
    - name: "🔍 Verify build output"
      run: |
        echo "Build directory contents:"
        ls -la dist/ || echo "No dist folder found - checking current directory:"
        ls -la
        echo "Looking for build artifacts:"
        find . -name "index.html" -o -name "*.js" -o -name "*.css" | head -10

    # Step 6: Create directory structure on server (if needed)
    - name: "📁 Ensure server directory exists"
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: /public_html/
        exclude: |
          **/*
          !.gitkeep
        protocol: ftp
        dangerous-clean-slate: false
        dry-run: false
        # This will create the directory structure without uploading all files

    # Step 7: Deploy to FTP
    - name: "🚀 Deploy to FTP Server"
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/
        server-dir: /public_html/
        protocol: ftp
        dangerous-clean-slate: false
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/*.md
          **/.env*
          **/README.md
          **/package*.json
          **/*.config.js
          **/src/
          **/public/
        # Logging options
        log-level: verbose
        # Security options
        server-dir: /public_html/

    # Step 8: Deployment success notification
    - name: "✅ Deployment successful"
      run: |
        echo "🎉 Deployment completed successfully!"
        echo "📁 Files deployed to: /public_html/"
        echo "🌐 Your site should be live soon..."